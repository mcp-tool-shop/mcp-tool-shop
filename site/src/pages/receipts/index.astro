---
import Base from "../../layouts/Base.astro";
import ProofBadge from "../../components/ProofBadge.astro";
import ReceiptLink from "../../components/ReceiptLink.astro";
import { kit } from '../../lib/kit';
import fs from "node:fs";
import path from "node:path";

const title = `Promotion Receipts - ${kit.site.title || 'mcp-tool-shop'}`;
const description = "Browse promotion receipts with hashed inputs and verification data for every promotion week.";

interface WeekEntry {
  week: string;
  itemCount: number;
  hasReceipt: boolean;
  hasCommit: boolean;
  hasInputHashes: boolean;
  generatedAt: string | null;
}

const weeks: WeekEntry[] = [];

const outreachDir = path.join(process.cwd(), "public/outreach-run");
try {
  if (fs.existsSync(outreachDir)) {
    const entries = fs.readdirSync(outreachDir, { withFileTypes: true });
    for (const entry of entries) {
      if (!entry.isDirectory()) continue;
      if (!/^\d{4}-\d{2}-\d{2}$/.test(entry.name)) continue;

      const weekDir = path.join(outreachDir, entry.name);

      // Load outreach-run.json for item count
      let outreachRun: any = null;
      try {
        const runPath = path.join(weekDir, "outreach-run.json");
        if (fs.existsSync(runPath)) {
          outreachRun = JSON.parse(fs.readFileSync(runPath, "utf8"));
        }
      } catch { /* skip */ }

      // Load receipt
      let receipt: any = null;
      try {
        const receiptPath = path.join(weekDir, "promo-week-receipt.json");
        if (fs.existsSync(receiptPath)) {
          receipt = JSON.parse(fs.readFileSync(receiptPath, "utf8"));
        }
      } catch { /* skip */ }

      if (!outreachRun && !receipt) continue;

      weeks.push({
        week: entry.name,
        itemCount: outreachRun?.items?.length || 0,
        hasReceipt: receipt !== null,
        hasCommit: !!(receipt?.inputs?.commitSha || receipt?.trustReceiptHash),
        hasInputHashes: !!(receipt?.inputs?.promoDecisionsSha),
        generatedAt: outreachRun?.generatedAt || receipt?.generatedAt || null,
      });
    }
  }
} catch { /* fail soft */ }

// Sort newest first
weeks.sort((a, b) => b.week.localeCompare(a.week));
---

<Base
  title={title}
  description={description}
  currentPath="/receipts/"
>
  <div class="receipts-page">
    <h1>Promotion Receipts</h1>
    <p class="subtitle">
      Every promotion week generates a receipt with hashed inputs and verification data.
    </p>

    {weeks.length === 0 ? (
      <div class="empty-state">
        <p>No promotion receipts yet.</p>
        <p>Check back after the next scheduled run.</p>
      </div>
    ) : (
      <div class="weeks-list">
        {weeks.map((w) => (
          <div class="week-card">
            <div class="week-header">
              <a href={`/promo/${w.week}/`} class="week-date">{w.week}</a>
              <span class="week-count">{w.itemCount} {w.itemCount === 1 ? "tool" : "tools"}</span>
            </div>
            <div class="week-badges">
              {w.hasReceipt && <ProofBadge type="receipt" />}
              {w.hasInputHashes && <ProofBadge type="hashed" />}
            </div>
            <div class="week-links">
              <a href={`/promo/${w.week}/`}>View promo week</a>
              {w.hasReceipt && (
                <ReceiptLink href={`/outreach-run/${w.week}/promo-week-receipt.json`} />
              )}
            </div>
          </div>
        ))}
      </div>
    )}

    <div class="provenance">
      <p>
        Receipts are generated by <code>gen-promo-week-receipt.mjs</code> during each outreach run.
        Learn more at the <a href="/trust/">Trust Center</a>.
      </p>
    </div>
  </div>
</Base>

<style>
  .receipts-page {
    max-width: 720px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  h1 {
    margin: 0 0 0.25rem;
    font-size: 2rem;
    color: var(--color-text, #e6edf3);
  }

  .subtitle {
    color: var(--color-text-muted, #8b949e);
    margin: 0 0 2rem;
    font-size: 0.95rem;
  }

  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--color-text-muted, #8b949e);
    font-size: 1.1rem;
    background: var(--color-surface, #161b22);
    border: 1px solid var(--color-border, #30363d);
    border-radius: 8px;
  }

  .empty-state p { margin: 0.5rem 0; }

  .weeks-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .week-card {
    background: var(--color-surface, #161b22);
    border: 1px solid var(--color-border, #30363d);
    border-radius: 8px;
    padding: 1rem;
  }

  .week-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .week-date {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--color-text, #e6edf3);
    text-decoration: none;
    font-variant-numeric: tabular-nums;
  }

  .week-date:hover { text-decoration: underline; color: #388bfd; }

  .week-count {
    font-size: 0.8rem;
    color: var(--color-text-muted, #8b949e);
  }

  .week-badges {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .week-links {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .week-links a {
    font-size: 0.8rem;
    color: #388bfd;
    text-decoration: none;
  }

  .week-links a:hover { text-decoration: underline; }

  .provenance {
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border, #30363d);
  }

  .provenance p {
    font-size: 0.8rem;
    color: var(--color-text-muted, #8b949e);
  }

  .provenance a {
    color: #388bfd;
    text-decoration: none;
  }

  .provenance a:hover { text-decoration: underline; }

  .provenance code {
    background: rgba(110, 118, 129, 0.2);
    padding: 0.1rem 0.35rem;
    border-radius: 3px;
    font-size: 0.8rem;
  }
</style>
