---
import Base from "../../../layouts/Base.astro";
import fs from "node:fs";
import path from "node:path";

const title = "Ops Dashboard";
const description = "NameOps pipeline run history â€” duration, cache hit rates, error codes";

// Load ops history
let history: any[] = [];
const dataPath = path.join(process.cwd(), "src/data/ops-history.json");
try {
  if (fs.existsSync(dataPath)) {
    history = JSON.parse(fs.readFileSync(dataPath, "utf8"));
  }
} catch {
  // No data available
}

// Load ops actions
let opsActions: any = { actions: [], capsDiff: {} };
const actionsPath = path.join(process.cwd(), "src/data/ops-actions.json");
try {
  if (fs.existsSync(actionsPath)) {
    opsActions = JSON.parse(fs.readFileSync(actionsPath, "utf8"));
  }
} catch {
  // No actions available
}

const actionsList = opsActions.actions || [];
const capsDiff = opsActions.capsDiff || {};

function actionIcon(level: string) {
  switch (level) {
    case "error": return "\u274c";
    case "warning": return "\u26a0\ufe0f";
    case "info": return "\u2139\ufe0f";
    default: return "\u2022";
  }
}

function categoryBadgeClass(category: string) {
  switch (category) {
    case "cache": return "badge-cache";
    case "errors": return "badge-errors";
    case "promotion": return "badge-promotion";
    case "duration": return "badge-duration";
    case "worthy": return "badge-worthy";
    default: return "badge-default";
  }
}

// Compute summary stats from history
const totalRuns = history.length;
const avgDuration = totalRuns > 0
  ? Math.round(history.reduce((s: number, h: any) => s + (h.totalDurationMs || 0), 0) / totalRuns / 1000)
  : 0;
const avgCacheRate = totalRuns > 0
  ? Math.round(history.reduce((s: number, h: any) => s + (h.costStats?.cacheHitRate || 0), 0) / totalRuns * 100)
  : 0;

// Last 7 runs for the table
const recentRuns = history.slice(0, 7);

// Aggregate adapter breakdown across recent runs
const adapterTotals: Record<string, { calls: number; cached: number }> = {};
for (const run of recentRuns) {
  if (!run.costStats?.adapterBreakdown) continue;
  for (const [ns, stats] of Object.entries(run.costStats.adapterBreakdown) as [string, any][]) {
    if (!adapterTotals[ns]) adapterTotals[ns] = { calls: 0, cached: 0 };
    adapterTotals[ns].calls += stats.calls || 0;
    adapterTotals[ns].cached += stats.cached || 0;
  }
}

// Aggregate error codes across recent runs
const errorTotals: Record<string, number> = {};
for (const run of recentRuns) {
  if (!run.errorCodes) continue;
  for (const [code, count] of Object.entries(run.errorCodes) as [string, number][]) {
    errorTotals[code] = (errorTotals[code] || 0) + count;
  }
}

function formatDate(dateStr: string) {
  try {
    return new Date(dateStr).toLocaleDateString("en-US", {
      month: "short",
      day: "numeric",
      year: "numeric",
    });
  } catch {
    return dateStr || "\u2014";
  }
}

function statusIcon(run: any) {
  if (run.batchOk && run.validationOk && (run.publishErrors || 0) === 0) return "\u2705";
  if (run.batchOk) return "\u26a0\ufe0f";
  return "\u274c";
}
---

<Base
  title={title}
  description={description}
  currentPath="/lab/ops/"
>
  <head>
    <meta name="robots" content="noindex, nofollow" />
  </head>

  <div class="ops-page">
    <span class="internal-badge">Internal</span>

    <h1>Ops Dashboard</h1>
    <p class="subtitle">NameOps pipeline run history &mdash; automated name clearance batch metrics.</p>

    {/* Summary banner */}
    <div class="summary-banner">
      <div class="stat">
        <span class="stat-value">{totalRuns}</span>
        <span class="stat-label">Total Runs</span>
      </div>
      <div class="stat">
        <span class="stat-value">{avgDuration}s</span>
        <span class="stat-label">Avg Duration</span>
      </div>
      <div class="stat">
        <span class="stat-value">{avgCacheRate}%</span>
        <span class="stat-label">Avg Cache Hit</span>
      </div>
    </div>

    {history.length === 0 ? (
      <div class="empty-state">
        <p>No ops history available.</p>
        <p>Pipeline runs will appear here after the first NameOps scheduled run.</p>
      </div>
    ) : (
      <>
        {/* Recent runs table */}
        <h2>Recent Runs</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Duration</th>
                <th class="num-header">Slugs</th>
                <th class="num-header">Cache Rate</th>
                <th class="num-header">Errors</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {recentRuns.map((run: any) => (
                <tr>
                  <td class="date-cell">{formatDate(run.date)}</td>
                  <td class="mono">{run.totalDurationHuman || `${Math.round((run.totalDurationMs || 0) / 1000)}s`}</td>
                  <td class="num">{run.slugCount ?? 0}</td>
                  <td class="num">{Math.round((run.costStats?.cacheHitRate || 0) * 100)}%</td>
                  <td class="num">{run.publishErrors ?? 0}</td>
                  <td>{statusIcon(run)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* Adapter breakdown */}
        {Object.keys(adapterTotals).length > 0 && (
          <>
            <h2>Adapter Breakdown <span class="period-label">(last {recentRuns.length} runs)</span></h2>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Namespace</th>
                    <th class="num-header">Calls</th>
                    <th class="num-header">Cached</th>
                    <th class="num-header">Hit Rate</th>
                  </tr>
                </thead>
                <tbody>
                  {Object.entries(adapterTotals)
                    .sort(([, a], [, b]) => (b as any).calls - (a as any).calls)
                    .map(([ns, stats]) => (
                      <tr>
                        <td class="mono">{ns}</td>
                        <td class="num">{(stats as any).calls}</td>
                        <td class="num">{(stats as any).cached}</td>
                        <td class="num">{(stats as any).calls > 0 ? Math.round((stats as any).cached / (stats as any).calls * 100) : 0}%</td>
                      </tr>
                    ))}
                </tbody>
              </table>
            </div>
          </>
        )}

        {/* Error codes */}
        {Object.keys(errorTotals).length > 0 && (
          <>
            <h2>Error Codes <span class="period-label">(last {recentRuns.length} runs)</span></h2>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Code</th>
                    <th class="num-header">Count</th>
                  </tr>
                </thead>
                <tbody>
                  {Object.entries(errorTotals)
                    .sort(([, a], [, b]) => (b as number) - (a as number))
                    .map(([code, count]) => (
                      <tr>
                        <td class="mono error-code">{code}</td>
                        <td class="num">{count as number}</td>
                      </tr>
                    ))}
                </tbody>
              </table>
            </div>
          </>
        )}

        {/* Minutes trend */}
        <h2>CI Minutes <span class="period-label">(per run)</span></h2>
        <div class="minutes-list">
          {history.slice(0, 10).map((run: any) => (
            <div class="minutes-entry">
              <span class="minutes-date">{formatDate(run.date)}</span>
              <span class="minutes-bar" style={`width: ${Math.min(100, (run.minutesEstimate || 1) * 10)}%;`}></span>
              <span class="minutes-value">{run.minutesEstimate || 1} min</span>
            </div>
          ))}
        </div>
      </>
    )}

    {/* Actions section */}
    {actionsList.length > 0 && (
      <>
        <h2>Actions</h2>
        <div class="actions-list">
          {actionsList.map((action: any) => (
            <div class={`action-card action-${action.level}`}>
              <div class="action-header">
                <span class="action-icon">{actionIcon(action.level)}</span>
                <span class={`action-category ${categoryBadgeClass(action.category)}`}>{action.category}</span>
              </div>
              <p class="action-message">{action.message}</p>
              <p class="action-recommendation">{action.action}</p>
              {action.runbookSection && (
                <span class="action-runbook">See: {action.runbookSection}</span>
              )}
            </div>
          ))}
        </div>
      </>
    )}

    {/* Caps diff */}
    {Object.keys(capsDiff).length > 0 && (
      <>
        <h2>Safety Caps <span class="period-label">(current)</span></h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Setting</th>
                <th>Value</th>
                <th>Changed</th>
              </tr>
            </thead>
            <tbody>
              {Object.entries(capsDiff).map(([key, val]: [string, any]) => (
                <tr>
                  <td class="mono">{key}</td>
                  <td class="mono">{String(val.current ?? "\u2014")}</td>
                  <td>{val.changed ? "\u26a0\ufe0f Yes" : "\u2014"}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </>
    )}

    <div class="provenance">
      <h3>Data Sources</h3>
      <ul>
        <li>History: <code>site/src/data/ops-history.json</code></li>
        <li>Actions: <code>site/src/data/ops-actions.json</code></li>
        <li>Ingestion: <code>scripts/ingest-ops.mjs</code></li>
        <li>Analysis: <code>scripts/gen-ops-actions.mjs</code></li>
        <li>Schedule: <code>.github/workflows/nameops-scheduled.yml</code> (Tue 06:00 UTC)</li>
      </ul>
    </div>
  </div>
</Base>

<style>
  .ops-page {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .internal-badge {
    display: inline-block;
    background: #d29922;
    color: #000;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  h1 {
    margin: 0 0 0.25rem;
    font-size: 2rem;
    color: var(--color-text, #e6edf3);
  }

  h2 {
    font-size: 1.1rem;
    color: var(--color-text, #e6edf3);
    margin: 2rem 0 0.75rem;
  }

  .subtitle {
    color: var(--color-text-muted, #8b949e);
    margin: 0 0 1.5rem;
    font-size: 0.95rem;
  }

  .period-label {
    font-weight: 400;
    font-size: 0.8rem;
    color: var(--color-text-muted, #8b949e);
  }

  /* Summary banner */
  .summary-banner {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 2rem;
    padding: 1rem;
    background: var(--color-surface, #161b22);
    border: 1px solid var(--color-border, #30363d);
    border-radius: 8px;
  }

  .stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
  }

  .stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--color-text, #e6edf3);
    font-variant-numeric: tabular-nums;
  }

  .stat-label {
    font-size: 0.75rem;
    color: var(--color-text-muted, #8b949e);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 0.25rem;
  }

  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--color-text-muted, #8b949e);
    font-size: 1.1rem;
    background: var(--color-surface, #161b22);
    border: 1px solid var(--color-border, #30363d);
    border-radius: 8px;
  }

  /* Tables */
  .table-wrap {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }

  th {
    text-align: left;
    padding: 0.5rem;
    border-bottom: 2px solid var(--color-border, #30363d);
    color: var(--color-text-muted, #8b949e);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .num-header {
    text-align: right;
  }

  td {
    padding: 0.5rem;
    border-bottom: 1px solid var(--color-border, #30363d);
    color: var(--color-text, #e6edf3);
  }

  .num {
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  .mono {
    font-family: monospace;
    font-size: 0.8rem;
  }

  .date-cell {
    color: var(--color-text-muted, #8b949e);
    font-size: 0.8rem;
  }

  .error-code {
    color: #f85149;
  }

  /* Minutes trend */
  .minutes-list {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .minutes-entry {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.8rem;
  }

  .minutes-date {
    min-width: 90px;
    color: var(--color-text-muted, #8b949e);
    font-size: 0.75rem;
  }

  .minutes-bar {
    height: 8px;
    background: rgba(56, 139, 253, 0.4);
    border-radius: 4px;
    min-width: 4px;
    transition: width 0.3s ease;
  }

  .minutes-value {
    font-variant-numeric: tabular-nums;
    color: var(--color-text, #e6edf3);
    font-size: 0.75rem;
    min-width: 40px;
  }

  /* Actions */
  .actions-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .action-card {
    padding: 0.75rem 1rem;
    border-radius: 6px;
    border-left: 3px solid var(--color-border, #30363d);
    background: var(--color-surface, #161b22);
  }

  .action-card.action-error {
    border-left-color: #f85149;
  }

  .action-card.action-warning {
    border-left-color: #d29922;
  }

  .action-card.action-info {
    border-left-color: #388bfd;
  }

  .action-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.4rem;
  }

  .action-icon {
    font-size: 0.9rem;
  }

  .action-category {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.1rem 0.45rem;
    border-radius: 3px;
  }

  .badge-cache { background: rgba(56, 139, 253, 0.15); color: #388bfd; }
  .badge-errors { background: rgba(248, 81, 73, 0.15); color: #f85149; }
  .badge-promotion { background: rgba(163, 113, 247, 0.15); color: #a371f7; }
  .badge-duration { background: rgba(210, 153, 34, 0.15); color: #d29922; }
  .badge-worthy { background: rgba(63, 185, 80, 0.15); color: #3fb950; }
  .badge-default { background: rgba(139, 148, 158, 0.15); color: #8b949e; }

  .action-message {
    margin: 0 0 0.3rem;
    font-size: 0.85rem;
    color: var(--color-text, #e6edf3);
  }

  .action-recommendation {
    margin: 0;
    font-size: 0.8rem;
    color: var(--color-text-muted, #8b949e);
    font-style: italic;
  }

  .action-runbook {
    display: inline-block;
    margin-top: 0.3rem;
    font-size: 0.7rem;
    color: var(--color-text-muted, #8b949e);
    opacity: 0.7;
  }

  /* Provenance */
  .provenance {
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border, #30363d);
    color: var(--color-text-muted, #8b949e);
    font-size: 0.8rem;
  }

  .provenance h3 {
    font-size: 0.85rem;
    margin: 0 0 0.5rem;
    color: var(--color-text-muted, #8b949e);
  }

  .provenance ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .provenance li {
    margin: 0.3rem 0;
  }

  .provenance code {
    background: rgba(110, 118, 129, 0.2);
    padding: 0.1rem 0.35rem;
    border-radius: 3px;
    font-size: 0.8rem;
  }

  @media (max-width: 600px) {
    .summary-banner {
      flex-direction: column;
      gap: 0.75rem;
    }

    .stat {
      flex-direction: row;
      justify-content: space-between;
    }

    .stat-value {
      font-size: 1.3rem;
    }

    table {
      font-size: 0.8rem;
    }
  }
</style>
