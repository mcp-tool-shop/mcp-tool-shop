---
import Base from "../../../layouts/Base.astro";
import fs from "node:fs";
import path from "node:path";

const title = "Worthy Scorecards";
const description = "Worthiness rubric results for mcp-tool-shop repos";

// Load worthy.json
let worthy: any = { rubric: { criteria: [], minimumScore: 0 }, repos: {} };
const worthyPath = path.join(process.cwd(), "src/data/worthy.json");
try {
  if (fs.existsSync(worthyPath)) {
    worthy = JSON.parse(fs.readFileSync(worthyPath, "utf8"));
  }
} catch { /* fail soft */ }

const rubric = worthy.rubric || { criteria: [], minimumScore: 0 };
const repos = worthy.repos || {};
const repoEntries = Object.entries(repos) as [string, any][];

// Stats
const totalRepos = repoEntries.length;
const worthyCount = repoEntries.filter(([, e]) => e.worthy).length;
const notWorthyCount = totalRepos - worthyCount;
const avgScore = totalRepos > 0
  ? Math.round(repoEntries.reduce((s: number, [, e]: [string, any]) => s + (e.score || 0), 0) / totalRepos * 10) / 10
  : 0;

// Split into worthy / not worthy
const worthyRepos = repoEntries.filter(([, e]) => e.worthy).sort(([, a], [, b]) => (b.score || 0) - (a.score || 0));
const notWorthyRepos = repoEntries.filter(([, e]) => !e.worthy).sort(([, a], [, b]) => (b.score || 0) - (a.score || 0));
---

<Base
  title={title}
  description={description}
  currentPath="/lab/worthy/"
>
  <head>
    <meta name="robots" content="noindex, nofollow" />
  </head>

  <div class="worthy-page">
    <span class="internal-badge">Internal</span>

    <h1>Worthy Scorecards</h1>
    <p class="subtitle">Worthiness rubric results &mdash; quality gate for ecosystem promotion.</p>

    {/* Summary banner */}
    <div class="summary-banner">
      <div class="stat">
        <span class="stat-value">{totalRepos}</span>
        <span class="stat-label">Total Repos</span>
      </div>
      <div class="stat">
        <span class="stat-value worthy-color">{worthyCount}</span>
        <span class="stat-label">Worthy</span>
      </div>
      <div class="stat">
        <span class="stat-value not-worthy-color">{notWorthyCount}</span>
        <span class="stat-label">Not Worthy</span>
      </div>
      <div class="stat">
        <span class="stat-value">{avgScore}</span>
        <span class="stat-label">Avg Score</span>
      </div>
    </div>

    {/* Rubric criteria */}
    {rubric.criteria.length > 0 && (
      <>
        <h2>Rubric Criteria <span class="period-label">(minimum: {rubric.minimumScore}/{rubric.criteria.length})</span></h2>
        <ol class="criteria-list">
          {rubric.criteria.map((c: string) => (
            <li>{c}</li>
          ))}
        </ol>
      </>
    )}

    {totalRepos === 0 ? (
      <div class="empty-state">
        <p>No repos assessed yet.</p>
        <p>Run the worthy assessment to populate this dashboard.</p>
      </div>
    ) : (
      <>
        {/* Worthy repos */}
        {worthyRepos.length > 0 && (
          <>
            <h2>Worthy Repos</h2>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Repo</th>
                    <th class="num-header">Score</th>
                    <th>Assessed</th>
                    <th>Reason</th>
                  </tr>
                </thead>
                <tbody>
                  {worthyRepos.map(([slug, entry]: [string, any]) => (
                    <tr>
                      <td class="mono">{slug}</td>
                      <td class="num worthy-color">{entry.score}/{rubric.criteria.length}</td>
                      <td class="date-cell">{entry.assessedDate || "\u2014"}</td>
                      <td>{entry.reason}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </>
        )}

        {/* Not worthy repos */}
        {notWorthyRepos.length > 0 && (
          <>
            <h2>Not Worthy</h2>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Repo</th>
                    <th class="num-header">Score</th>
                    <th class="num-header">Missing</th>
                    <th>Scorecard</th>
                  </tr>
                </thead>
                <tbody>
                  {notWorthyRepos.map(([slug, entry]: [string, any]) => (
                    <tr>
                      <td class="mono">{slug}</td>
                      <td class="num not-worthy-color">{entry.score}/{rubric.criteria.length}</td>
                      <td class="num">{(entry.missing || []).length}</td>
                      <td><a href={`/lab/worthy/${slug}/scorecard.md`}>View</a></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </>
        )}
      </>
    )}

    <div class="provenance">
      <h3>Data Sources</h3>
      <ul>
        <li>Rubric: <code>site/src/data/worthy.json</code></li>
        <li>Scorecards: <code>scripts/gen-worthy-scorecard.mjs</code></li>
      </ul>
    </div>
  </div>
</Base>

<style>
  .worthy-page {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .internal-badge {
    display: inline-block;
    background: #d29922;
    color: #000;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  h1 {
    margin: 0 0 0.25rem;
    font-size: 2rem;
    color: var(--color-text, #e6edf3);
  }

  h2 {
    font-size: 1.1rem;
    color: var(--color-text, #e6edf3);
    margin: 2rem 0 0.75rem;
  }

  .subtitle {
    color: var(--color-text-muted, #8b949e);
    margin: 0 0 1.5rem;
    font-size: 0.95rem;
  }

  .period-label {
    font-weight: 400;
    font-size: 0.8rem;
    color: var(--color-text-muted, #8b949e);
  }

  .summary-banner {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 2rem;
    padding: 1rem;
    background: var(--color-surface, #161b22);
    border: 1px solid var(--color-border, #30363d);
    border-radius: 8px;
  }

  .stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
  }

  .stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--color-text, #e6edf3);
    font-variant-numeric: tabular-nums;
  }

  .stat-label {
    font-size: 0.75rem;
    color: var(--color-text-muted, #8b949e);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 0.25rem;
  }

  .worthy-color { color: #3fb950; }
  .not-worthy-color { color: #f85149; }

  .criteria-list {
    padding-left: 1.5rem;
    margin: 0;
  }

  .criteria-list li {
    margin: 0.3rem 0;
    font-size: 0.9rem;
    color: var(--color-text, #e6edf3);
  }

  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--color-text-muted, #8b949e);
    font-size: 1.1rem;
    background: var(--color-surface, #161b22);
    border: 1px solid var(--color-border, #30363d);
    border-radius: 8px;
  }

  .table-wrap { overflow-x: auto; }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }

  th {
    text-align: left;
    padding: 0.5rem;
    border-bottom: 2px solid var(--color-border, #30363d);
    color: var(--color-text-muted, #8b949e);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .num-header { text-align: right; }

  td {
    padding: 0.5rem;
    border-bottom: 1px solid var(--color-border, #30363d);
    color: var(--color-text, #e6edf3);
  }

  .num {
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  .mono {
    font-family: monospace;
    font-size: 0.8rem;
  }

  .date-cell {
    color: var(--color-text-muted, #8b949e);
    font-size: 0.8rem;
  }

  td a {
    color: #388bfd;
    text-decoration: none;
    font-size: 0.8rem;
  }

  td a:hover { text-decoration: underline; }

  .provenance {
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border, #30363d);
    color: var(--color-text-muted, #8b949e);
    font-size: 0.8rem;
  }

  .provenance h3 {
    font-size: 0.85rem;
    margin: 0 0 0.5rem;
    color: var(--color-text-muted, #8b949e);
  }

  .provenance ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .provenance li { margin: 0.3rem 0; }

  .provenance code {
    background: rgba(110, 118, 129, 0.2);
    padding: 0.1rem 0.35rem;
    border-radius: 3px;
    font-size: 0.8rem;
  }

  @media (max-width: 600px) {
    .summary-banner {
      flex-direction: column;
      gap: 0.75rem;
    }

    .stat {
      flex-direction: row;
      justify-content: space-between;
    }

    .stat-value { font-size: 1.3rem; }
    table { font-size: 0.8rem; }
  }
</style>
