---
import Base from '../../layouts/Base.astro';
import fs from 'node:fs';
import path from 'node:path';

// Load signals data (most recent file)
const signalsDir = path.join(process.cwd(), 'src/data/signals');
const linksPath = path.join(process.cwd(), 'src/data/links.json');

function loadJson(filePath: string) {
  try {
    return JSON.parse(fs.readFileSync(filePath, 'utf8'));
  } catch {
    return null;
  }
}

// Find most recent signals file
let latestSignals: any = null;
let allSignalFiles: string[] = [];
try {
  const files = fs.readdirSync(signalsDir)
    .filter((f: string) => f.endsWith('.json'))
    .sort()
    .reverse();
  allSignalFiles = files;
  if (files.length > 0) {
    latestSignals = loadJson(path.join(signalsDir, files[0]));
  }
} catch {
  // signals dir doesn't exist yet — that's fine
}

const linksData = loadJson(linksPath);
const links = linksData?.links || [];

// Build lookup maps
const signalByLink = new Map<string, any>();
if (latestSignals?.signals) {
  for (const sig of latestSignals.signals) {
    signalByLink.set(sig.linkId, sig);
  }
}

// Aggregate stats
const totalHits = latestSignals?.signals?.reduce((sum: number, s: any) => sum + s.codeSearchHits, 0) || 0;
const totalExternal = latestSignals?.signals?.reduce((sum: number, s: any) => sum + s.externalHits, 0) || 0;
const linksWithHits = latestSignals?.signals?.filter((s: any) => s.externalHits > 0).length || 0;

// Group links by channel
const byChannel = new Map<string, any[]>();
for (const link of links) {
  if (!byChannel.has(link.channel)) byChannel.set(link.channel, []);
  byChannel.get(link.channel)!.push(link);
}

// GitHub facts from signals
const facts = latestSignals?.githubFacts || [];

// Channel colors
const channelColors: Record<string, string> = {
  web: '#58a6ff',
  readme: '#3fb950',
  hn: '#ff7b72',
  x: '#8b949e',
  linkedin: '#58a6ff',
  cta: '#d29922',
  newsletter: '#bc8cff',
  presskit: '#f0883e',
};
---

<Base
  title="Distribution Signals - Internal"
  description="Internal dashboard for tracking go-link distribution signals."
  currentPath="/lab/signals/"
>
  <head>
    <meta name="robots" content="noindex, nofollow" />
  </head>

  <div class="signals-page">
    <div class="internal-badge">Internal Preview</div>

    <h1>Distribution Signals</h1>
    <p class="subtitle">Go-link usage, code search mentions, and GitHub adoption metrics.</p>

    {/* Summary banner */}
    {latestSignals ? (
      <div class="summary-banner">
        <div class="summary-grid">
          <div class="summary-item">
            <span class="value">{links.length}</span>
            <span class="label">Go-links</span>
          </div>
          <div class="summary-item">
            <span class="value">{totalHits}</span>
            <span class="label">Code search hits</span>
          </div>
          <div class="summary-item">
            <span class="value">{totalExternal}</span>
            <span class="label">External mentions</span>
          </div>
          <div class="summary-item">
            <span class="value">{linksWithHits}</span>
            <span class="label">Links with hits</span>
          </div>
          <div class="summary-item">
            <span class="value">{allSignalFiles.length}</span>
            <span class="label">Collections</span>
          </div>
        </div>
        <div class="snapshot-meta">
          Collected: {new Date(latestSignals.collectedAt).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' })}
          {latestSignals.errors?.length > 0 && (
            <span class="error-count"> | {latestSignals.errors.length} error(s)</span>
          )}
        </div>
      </div>
    ) : (
      <div class="summary-banner empty">
        <p>No signals data collected yet.</p>
        <p>Run <code>GITHUB_TOKEN=... node scripts/fetch-distribution-signals.mjs</code> to collect.</p>
      </div>
    )}

    {/* Go-links table */}
    <section class="section">
      <h2>Go-Links</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Channel</th>
              <th>Target</th>
              <th>Hits</th>
              <th>External</th>
            </tr>
          </thead>
          <tbody>
            {links.map((link: any) => {
              const sig = signalByLink.get(link.id);
              const hits = sig?.codeSearchHits ?? '—';
              const ext = sig?.externalHits ?? '—';
              const hasHits = sig?.externalHits > 0;
              return (
                <tr class={hasHits ? 'has-hits' : ''}>
                  <td>
                    <code class="link-id">{link.id}</code>
                  </td>
                  <td>
                    <span class="channel-tag" style={`background: ${channelColors[link.channel] || '#8b949e'}22; color: ${channelColors[link.channel] || '#8b949e'}`}>
                      {link.channel}
                    </span>
                  </td>
                  <td class="target-cell">
                    <span class="target-url">{link.target.replace('https://', '')}</span>
                  </td>
                  <td class="num">{hits}</td>
                  <td class="num">{ext}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </section>

    {/* Channel breakdown */}
    <section class="section">
      <h2>By Channel</h2>
      <div class="channel-grid">
        {[...byChannel.entries()].map(([channel, channelLinks]) => {
          const channelTotal = channelLinks.reduce((sum: number, l: any) => {
            const sig = signalByLink.get(l.id);
            return sum + (sig?.codeSearchHits || 0);
          }, 0);
          const channelExternal = channelLinks.reduce((sum: number, l: any) => {
            const sig = signalByLink.get(l.id);
            return sum + (sig?.externalHits || 0);
          }, 0);
          return (
            <div class="channel-card">
              <div class="channel-header">
                <span class="channel-tag" style={`background: ${channelColors[channel] || '#8b949e'}22; color: ${channelColors[channel] || '#8b949e'}`}>
                  {channel}
                </span>
                <span class="channel-count">{channelLinks.length} links</span>
              </div>
              <div class="channel-stats">
                <div class="stat">
                  <span class="stat-value">{channelTotal}</span>
                  <span class="stat-label">hits</span>
                </div>
                <div class="stat">
                  <span class="stat-value">{channelExternal}</span>
                  <span class="stat-label">external</span>
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </section>

    {/* External mentions detail */}
    {latestSignals?.signals?.some((s: any) => s.results?.length > 0) && (
      <section class="section">
        <h2>External Mentions</h2>
        <div class="mentions-list">
          {latestSignals.signals
            .filter((s: any) => s.results?.length > 0)
            .map((s: any) => (
              <div class="mention-group">
                <h3>
                  <code>{s.linkId}</code>
                  <span class="mention-count">{s.results.length} mention(s)</span>
                </h3>
                {s.results.map((r: any) => (
                  <div class="mention-item">
                    <span class="mention-repo">{r.repo}</span>
                    <span class="mention-file">{r.file}</span>
                  </div>
                ))}
              </div>
            ))}
        </div>
      </section>
    )}

    {/* GitHub facts */}
    {facts.length > 0 && (
      <section class="section">
        <h2>GitHub Adoption</h2>
        <div class="facts-grid">
          {facts.map((f: any) => (
            <div class="fact-card">
              <h3>{f.slug}</h3>
              <div class="fact-stats">
                {f.stars != null && (
                  <div class="fact-stat">
                    <span class="fact-value">{f.stars}</span>
                    <span class="fact-label">stars</span>
                  </div>
                )}
                {f.forks != null && (
                  <div class="fact-stat">
                    <span class="fact-value">{f.forks}</span>
                    <span class="fact-label">forks</span>
                  </div>
                )}
                {f.openIssues != null && (
                  <div class="fact-stat">
                    <span class="fact-value">{f.openIssues}</span>
                    <span class="fact-label">issues</span>
                  </div>
                )}
                {f.releasesLast90d != null && (
                  <div class="fact-stat">
                    <span class="fact-value">{f.releasesLast90d}</span>
                    <span class="fact-label">releases (90d)</span>
                  </div>
                )}
              </div>
              {f.latestRelease && (
                <div class="fact-release">
                  Latest: <code>{f.latestRelease}</code>
                </div>
              )}
              {f.traffic && (
                <div class="fact-traffic">
                  Traffic (14d): {f.traffic.views14d} views, {f.traffic.uniques14d} uniques
                </div>
              )}
              <div class="fact-fetched">
                Fetched: {new Date(f.fetchedAt).toLocaleDateString('en-US', { dateStyle: 'medium' })}
              </div>
            </div>
          ))}
        </div>
      </section>
    )}

    {/* Collection history */}
    {allSignalFiles.length > 1 && (
      <section class="section">
        <h2>Collection History</h2>
        <div class="history-list">
          {allSignalFiles.map((file: string) => (
            <div class="history-item">
              <code>{file}</code>
            </div>
          ))}
        </div>
      </section>
    )}

    {/* Provenance */}
    <section class="section provenance">
      <h2>Data Sources</h2>
      <ul>
        <li>Go-link registry: <code>links.json</code> ({links.length} links, generated by <code>gen-links.mjs</code>)</li>
        <li>Code search signals: GitHub Code Search API (best-effort, excludes own org)</li>
        <li>GitHub facts: <code>fetch-github-facts.mjs</code> (stars, forks, releases, traffic)</li>
        <li>Signal collector: <code>fetch-distribution-signals.mjs</code> (manual/scheduled, NOT every deploy)</li>
      </ul>
    </section>
  </div>
</Base>

<style>
  .signals-page {
    padding: 2rem 0;
  }
  .internal-badge {
    display: inline-block;
    background: #d2992233;
    color: #d29922;
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 1rem;
  }
  h1 {
    margin: 0 0 0.25rem;
  }
  .subtitle {
    color: var(--color-text-muted);
    margin: 0 0 1.5rem;
  }

  /* Summary banner */
  .summary-banner {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.25rem;
    margin-bottom: 2rem;
  }
  .summary-banner.empty {
    color: var(--color-text-muted);
    text-align: center;
    padding: 2rem;
  }
  .summary-banner.empty p {
    margin: 0.25rem 0;
  }
  .summary-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 2rem;
    margin-bottom: 0.75rem;
  }
  .summary-item {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
  }
  .summary-item .value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text);
  }
  .summary-item .label {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .snapshot-meta {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }
  .error-count {
    color: #f85149;
  }

  /* Sections */
  .section {
    margin-bottom: 2rem;
  }
  .section h2 {
    font-size: 1.1rem;
    margin: 0 0 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--color-border);
  }

  /* Table */
  .table-wrap {
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
  }
  th {
    text-align: left;
    padding: 0.5rem 0.75rem;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    border-bottom: 1px solid var(--color-border);
  }
  td {
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid var(--color-border);
  }
  tr.has-hits {
    background: #3fb95008;
  }
  .link-id {
    font-size: 0.8rem;
  }
  .target-cell {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .target-url {
    font-size: 0.8rem;
    color: var(--color-text-muted);
  }
  .num {
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  /* Channel tags */
  .channel-tag {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: 3px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  /* Channel grid */
  .channel-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
  }
  .channel-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1rem;
  }
  .channel-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }
  .channel-count {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }
  .channel-stats {
    display: flex;
    gap: 1.5rem;
  }
  .stat {
    display: flex;
    flex-direction: column;
  }
  .stat-value {
    font-size: 1.25rem;
    font-weight: 700;
  }
  .stat-label {
    font-size: 0.7rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
  }

  /* Mentions */
  .mentions-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .mention-group h3 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.9rem;
    margin: 0 0 0.5rem;
  }
  .mention-count {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    font-weight: 400;
  }
  .mention-item {
    display: flex;
    gap: 1rem;
    font-size: 0.8rem;
    padding: 0.35rem 0.75rem;
    background: var(--color-surface);
    border-radius: var(--radius);
    margin-bottom: 0.25rem;
  }
  .mention-repo {
    font-weight: 500;
    min-width: 200px;
  }
  .mention-file {
    color: var(--color-text-muted);
  }

  /* Facts grid */
  .facts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
  }
  .fact-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1rem;
  }
  .fact-card h3 {
    margin: 0 0 0.75rem;
    font-size: 0.95rem;
  }
  .fact-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 1.25rem;
    margin-bottom: 0.75rem;
  }
  .fact-stat {
    display: flex;
    flex-direction: column;
  }
  .fact-value {
    font-size: 1.1rem;
    font-weight: 700;
  }
  .fact-label {
    font-size: 0.7rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
  }
  .fact-release, .fact-traffic, .fact-fetched {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    margin-top: 0.25rem;
  }

  /* History */
  .history-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .history-item code {
    font-size: 0.8rem;
    background: var(--color-surface);
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius);
  }

  /* Provenance */
  .provenance ul {
    font-size: 0.85rem;
    color: var(--color-text-muted);
    padding-left: 1.25rem;
  }
  .provenance li {
    margin-bottom: 0.35rem;
  }

  code {
    font-family: var(--font-mono);
  }
</style>
