---
import Base from '../../layouts/Base.astro';
import PublicProof from '../../components/marketir/PublicProof.astro';
import RealityPanel from '../../components/RealityPanel.astro';
import TryItNow from '../../components/TryItNow.astro';
import projects from '../../data/projects.json';
import proofs from '../../data/audit/proofs.json';
import releases from '../../data/releases.json';
import overrides from '../../data/overrides.json';
import { getProofData, getPressData, loadSnapshot } from '../../lib/marketir/loader.mjs';

export function getStaticPaths() {
  return (projects as any[]).map((project: any) => ({
    params: { slug: project.repo },
    props: { project },
  }));
}

const { project } = Astro.props;
const orgUrl = `https://github.com/mcp-tool-shop-org/${project.repo}`;
const toolProof = (proofs as any[]).find((p: any) => p.repo === project.repo);

// Registry status
const isRegistered = project.registered === true;
const isDeprecated = project.deprecated === true;

// Install command resolution: override > registry-computed > none
const installCmd = project.install || null;

// Trust signals
const hasInstall = Boolean(installCmd);
const hasRelease = (releases as any[]).some((r: any) => r.repo === project.repo);
const hasDescription = Boolean(project.tagline || project.description);
const latestRelease = (releases as any[]).find((r: any) => r.repo === project.repo);

// Related tools: share at least one tag, exclude self
const projectTags = new Set(project.tags || []);
const related = (projects as any[])
  .filter((p: any) => p.repo !== project.repo && (p.tags || []).some((t: string) => projectTags.has(t)))
  .slice(0, 3);

// Public Proof (opt-in via overrides.json)
const toolOverride = (overrides as any)[project.repo];
const showProof = toolOverride?.publicProof === true;
const proofData = showProof ? getProofData(project.repo) : null;
const snapshot = showProof && proofData ? loadSnapshot() : null;
const pressData = showProof ? getPressData(project.repo) : null;
---

<Base
  title={`${project.name} - mcp-tool-shop`}
  description={project.tagline || project.description}
  currentPath={`/tools/${project.repo}/`}
>
  <div class="tool-detail">
    <a href="/tools/" class="back-link">&larr; All tools</a>

    <div class="tool-header">
      <h1>{project.name}</h1>
      <div class="tool-badges">
        {isRegistered ? (
          <span class="badge badge-registered" title="Listed in the MCP Tool Shop registry — verified metadata and install contract">Registry</span>
        ) : (
          <span class="badge badge-orgonly" title="Available in the org but not yet listed in the registry">Org-only</span>
        )}
        {isDeprecated && (
          <span class="badge badge-deprecated" title="This tool has been archived or deprecated">Deprecated</span>
        )}
        {project.stability && (
          <span class={`badge badge-${project.stability}`}>{project.stability}</span>
        )}
        {project.kind && (
          <span class="badge badge-kind">{project.kind}</span>
        )}
        {project.language && (
          <span class="badge badge-kind">{project.language}</span>
        )}
      </div>
    </div>

    {toolProof && (
      <RealityPanel 
        verified={toolProof.verified} 
        concept={toolProof.concept} 
        proofs={toolProof.proofs} 
      />
    )}

    {toolProof && (
      <TryItNow
        project={project}
        verified={toolProof.verified}
        concept={toolProof.concept}
        proofs={toolProof.proofs}
      />
    )}

    {isDeprecated && (
      <div class="deprecated-notice">
        This tool has been deprecated or its repository has been archived.
        It may no longer be maintained or receive updates.
      </div>
    )}

    <p class="tool-description">{project.tagline || project.description}</p>

    {project.description && project.tagline && project.tagline !== project.description && (
      <p class="tool-full-desc">{project.description}</p>
    )}

    {project.screenshot && (
      <div class="screenshot-block">
        <img
          src={project.screenshot}
          alt={`${project.name} screenshot`}
          loading="lazy"
          width="720"
        />
        {project.screenshotType === 'placeholder' && (
          <span class="screenshot-label">preview</span>
        )}
      </div>
    )}

    {/* Old install block removed in favor of TryItNow component */}

    <div class="tool-links">
      <a href={orgUrl} class="btn btn-primary" rel="noopener">View on GitHub</a>
      <a href={`${orgUrl}/issues`} class="btn btn-secondary" rel="noopener">Issues</a>
      <a href={`${orgUrl}/releases`} class="btn btn-secondary" rel="noopener">Releases</a>
      {showProof && (
        <a href={`/presskit/${project.repo}/`} class="btn btn-secondary">Press Kit</a>
      )}
      {showProof && pressData && (
        <a href={`/press/${project.repo}/`} class="btn btn-secondary">Press Page</a>
      )}
    </div>

    {(project.goodFor || project.notFor) && (
      <div class="fit-section">
        {project.goodFor && (
          <div class="fit-col">
            <h2>Good for</h2>
            <ul>
              {project.goodFor.map((item: string) => (
                <li>{item}</li>
              ))}
            </ul>
          </div>
        )}
        {project.notFor && (
          <div class="fit-col">
            <h2>Not for</h2>
            <ul>
              {project.notFor.map((item: string) => (
                <li>{item}</li>
              ))}
            </ul>
          </div>
        )}
      </div>
    )}

    <div class="tool-meta-grid">
      {project.stars > 0 && (
        <div class="meta-block">
          <span class="meta-label">Stars</span>
          <span class="meta-value">{project.stars}</span>
        </div>
      )}
      {project.language && (
        <div class="meta-block">
          <span class="meta-label">Language</span>
          <span class="meta-value">{project.language}</span>
        </div>
      )}
      {project.updatedAt && (
        <div class="meta-block">
          <span class="meta-label">Last updated</span>
          <span class="meta-value">{new Date(project.updatedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
        </div>
      )}
    </div>

    <div class="signal-strip">
      <span class={`signal ${isRegistered ? 'signal-yes' : 'signal-no'}`}>
        {isRegistered ? 'Registry listed' : 'Not in registry'}
      </span>
      <span class={`signal ${hasInstall ? 'signal-yes' : 'signal-no'}`}>
        {hasInstall ? 'Install cmd' : 'No install cmd'}
      </span>
      <span class={`signal ${hasRelease ? 'signal-yes' : 'signal-no'}`}>
        {hasRelease ? 'Has releases' : 'No releases'}
      </span>
      <span class={`signal ${hasDescription ? 'signal-yes' : 'signal-no'}`}>
        {hasDescription ? 'Documented' : 'No description'}
      </span>
    </div>

    {latestRelease && (
      <div class="latest-release">
        <span class="meta-label">Latest release</span>
        <a href={latestRelease.url} rel="noopener">
          {latestRelease.tag}
          {latestRelease.name && latestRelease.name !== latestRelease.tag && (
            <span class="release-name-inline"> — {latestRelease.name}</span>
          )}
        </a>
        {latestRelease.publishedAt && (
          <span class="release-date-inline">
            {new Date(latestRelease.publishedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
          </span>
        )}
      </div>
    )}

    {project.tags && project.tags.length > 0 && (
      <div class="tool-tags">
        {project.tags.map((tag: string) => (
          <span class="tag">{tag}</span>
        ))}
      </div>
    )}

    {showProof && proofData && snapshot && (
      <PublicProof proofData={proofData} snapshot={snapshot} />
    )}

    {related.length > 0 && (
      <div class="related-section">
        <h2>Related tools</h2>
        <div class="related-grid">
          {related.map((p: any) => (
            <a href={`/tools/${p.repo}/`} class="related-item">
              <span class="related-name">{p.name}</span>
              <span class="related-desc">{p.tagline || p.description}</span>
            </a>
          ))}
        </div>
      </div>
    )}
  </div>
</Base>

<style>
  .tool-detail {
    max-width: 720px;
  }

  .back-link {
    display: inline-block;
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    margin-bottom: 1.5rem;
  }

  .back-link:hover {
    color: var(--color-accent);
  }

  .tool-header {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }

  .tool-header h1 {
    font-size: 2rem;
    margin: 0;
  }

  .tool-badges {
    display: flex;
    gap: 0.375rem;
    padding-top: 0.5rem;
  }

  .badge {
    font-family: var(--font-mono);
    font-size: 0.625rem;
    padding: 0.125em 0.5em;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    white-space: nowrap;
  }

  .badge-stable {
    color: var(--color-success);
    background: rgba(63, 185, 80, 0.1);
  }

  .badge-beta {
    color: #d29922;
    background: rgba(210, 153, 34, 0.1);
  }

  .badge-experimental {
    color: #f85149;
    background: rgba(248, 81, 73, 0.1);
  }

  .badge-kind {
    color: var(--color-text-muted);
    background: rgba(139, 148, 158, 0.1);
  }

  .badge-registered {
    color: var(--color-accent);
    background: rgba(88, 166, 255, 0.1);
  }

  .badge-orgonly {
    color: var(--color-text-muted);
    background: rgba(139, 148, 158, 0.06);
    border: 1px dashed rgba(139, 148, 158, 0.2);
  }

  .badge-deprecated {
    color: #f85149;
    background: rgba(248, 81, 73, 0.1);
    border: 1px solid rgba(248, 81, 73, 0.2);
  }

  .deprecated-notice {
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    font-size: 0.8125rem;
    color: #f85149;
    background: rgba(248, 81, 73, 0.06);
    border: 1px solid rgba(248, 81, 73, 0.15);
    border-radius: var(--radius);
    line-height: 1.5;
  }

  .tool-description {
    font-size: 1.125rem;
    color: var(--color-text-muted);
    margin-bottom: 0.5rem;
    line-height: 1.5;
  }

  .tool-full-desc {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: 1.5rem;
  }

  .screenshot-block {
    position: relative;
    margin: 1.5rem 0;
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .screenshot-block img {
    display: block;
    width: 100%;
    height: auto;
  }

  .screenshot-label {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    font-family: var(--font-mono);
    font-size: 0.625rem;
    color: var(--color-text-muted);
    background: rgba(13, 17, 23, 0.8);
    padding: 0.15em 0.5em;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .install-block {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 0.625rem 1rem;
    margin: 1.5rem 0;
  }

  .install-label {
    font-size: 0.6875rem;
    font-family: var(--font-mono);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    flex-shrink: 0;
  }

  .install-block code {
    flex: 1;
    background: none;
    padding: 0;
    font-size: 0.875rem;
    color: var(--color-text);
    overflow-x: auto;
    white-space: nowrap;
  }

  .copy-btn {
    font-family: var(--font-mono);
    font-size: 0.6875rem;
    color: var(--color-accent);
    background: var(--color-accent-subtle);
    border: none;
    border-radius: 3px;
    padding: 0.25em 0.625em;
    cursor: pointer;
    flex-shrink: 0;
    transition: background 0.15s;
  }

  .copy-btn:hover {
    background: rgba(88, 166, 255, 0.2);
  }

  .tool-links {
    display: flex;
    gap: 0.75rem;
    margin: 1.5rem 0;
    flex-wrap: wrap;
  }

  .fit-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin: 2rem 0;
    padding: 1.25rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
  }

  .fit-section h2 {
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: var(--color-text);
  }

  .fit-col ul {
    list-style: none;
    padding: 0;
  }

  .fit-col li {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    margin-bottom: 0.5rem;
    padding-left: 1em;
    position: relative;
  }

  .fit-col:first-child li::before {
    content: '+';
    position: absolute;
    left: 0;
    color: var(--color-success);
    font-weight: 700;
  }

  .fit-col:last-child li::before {
    content: '-';
    position: absolute;
    left: 0;
    color: var(--color-text-muted);
    font-weight: 700;
  }

  .tool-meta-grid {
    display: flex;
    gap: 2rem;
    margin: 2rem 0 1.5rem;
    flex-wrap: wrap;
  }

  .meta-block {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .meta-label {
    font-size: 0.6875rem;
    font-family: var(--font-mono);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .meta-value {
    font-size: 0.875rem;
    color: var(--color-text);
  }

  .tool-tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border);
  }

  .signal-strip {
    display: flex;
    gap: 0.75rem;
    margin: 1.5rem 0;
    flex-wrap: wrap;
  }

  .signal {
    font-family: var(--font-mono);
    font-size: 0.6875rem;
    padding: 0.2em 0.625em;
    border-radius: 3px;
  }

  .signal-yes {
    color: var(--color-success);
    background: rgba(63, 185, 80, 0.08);
  }

  .signal-no {
    color: var(--color-text-muted);
    background: rgba(139, 148, 158, 0.08);
  }

  .latest-release {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .latest-release a {
    font-family: var(--font-mono);
    font-size: 0.875rem;
  }

  .release-name-inline {
    font-family: var(--font-sans);
    color: var(--color-text-muted);
    font-size: 0.8125rem;
  }

  .release-date-inline {
    font-family: var(--font-mono);
    font-size: 0.6875rem;
    color: var(--color-text-muted);
  }

  .related-section {
    margin-top: 2.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border);
  }

  .related-section h2 {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.75rem;
  }

  .related-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 0.75rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    text-decoration: none;
    transition: border-color 0.15s;
  }

  .related-item:hover {
    border-color: var(--color-accent);
    text-decoration: none;
  }

  .related-name {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-accent);
  }

  .related-desc {
    font-size: 0.6875rem;
    color: var(--color-text-muted);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  @media (max-width: 640px) {
    .fit-section {
      grid-template-columns: 1fr;
    }

    .tool-header {
      flex-direction: column;
      gap: 0.5rem;
    }

    .tool-badges {
      padding-top: 0;
    }
  }
</style>

<script>
  import { trackEvent } from '../../lib/tracker';

  const copyBtn = document.getElementById('copy-install');
  const installCmd = document.getElementById('install-cmd');
  if (copyBtn && installCmd) {
    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(installCmd.textContent || '');
        const slug = window.location.pathname.split('/tools/')[1]?.replace(/\/$/, '') || '';
        trackEvent('copy_install', { slug });
        copyBtn.textContent = 'Copied!';
        setTimeout(() => { copyBtn.textContent = 'Copy'; }, 1500);
      } catch {
        copyBtn.textContent = 'Failed';
        setTimeout(() => { copyBtn.textContent = 'Copy'; }, 1500);
      }
    });
  }
</script>
