name: Weekly screenshot backlog

on:
  workflow_dispatch: {}
  schedule:
    # Every Wednesday at 08:00 UTC — stagger from override drafts (Monday)
    - cron: '0 8 * * 3'

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: screenshots-weekly
  cancel-in-progress: true

jobs:
  screenshots:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install sharp (needed for PNG generation)
        run: cd site && npm install sharp --no-save

      - name: Generate placeholder screenshots
        run: node scripts/gen-placeholders.mjs

      - name: Check for new screenshots
        id: diff
        run: |
          NEW_PNGS=$(git diff --name-only --diff-filter=A site/public/screenshots/ | wc -l)
          CHANGED=$(git diff --quiet site/src/data/overrides.json && echo false || echo true)

          echo "new_pngs=$NEW_PNGS" >> "$GITHUB_OUTPUT"
          echo "changed=$CHANGED" >> "$GITHUB_OUTPUT"

      - name: Push screenshot branch and open PR
        if: steps.diff.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="auto/screenshots-weekly"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add site/public/screenshots/
          git add site/src/data/overrides.json
          git add site/src/data/projects.json

          git checkout -B "$BRANCH"
          git commit -m "chore(auto): generate placeholder screenshots"
          git push --force origin "$BRANCH"

          EXISTING=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number // empty')

          BODY="## Placeholder screenshots

          Generated placeholder PNGs for flagship tools missing screenshots.

          New placeholders: ${{ steps.diff.outputs.new_pngs }}

          These are auto-generated dark-themed cards showing tool name, tagline, badges, and install command. Replace them with real screenshots when available."

          if [ -n "$EXISTING" ]; then
            echo "Updating existing PR #$EXISTING"
            gh pr edit "$EXISTING" --body "$BODY" || echo "::warning::Could not update PR body."
          else
            echo "Creating new PR"
            gh pr create \
              --title "chore(auto): placeholder screenshots" \
              --body "$BODY" \
              --base main \
              --head "$BRANCH" \
            || echo "::warning::Could not create PR. Create manually."
          fi

      - name: Build screenshot backlog issue body
        id: backlog
        run: |
          node -e "
          const fs = require('fs');
          const overrides = JSON.parse(fs.readFileSync('site/src/data/overrides.json', 'utf8'));
          const projects = JSON.parse(fs.readFileSync('site/src/data/projects.json', 'utf8'));
          const projectMap = new Map(projects.map(p => [p.repo, p]));

          const placeholders = Object.entries(overrides)
            .filter(([_, v]) => v.screenshotType === 'placeholder')
            .map(([repo]) => repo);

          const noScreenshot = projects
            .filter(p => !overrides[p.repo]?.screenshot)
            .filter(p => p.featured || p.install)
            .map(p => p.repo);

          let body = '## Screenshot Backlog\n\n';
          body += 'Tools with placeholder screenshots that should be replaced with real ones.\n\n';

          if (placeholders.length > 0) {
            body += '### Placeholders to replace (' + placeholders.length + ')\n\n';
            for (const repo of placeholders) {
              const p = projectMap.get(repo);
              const name = p ? p.name : repo;
              body += '- [ ] **' + name + '** (\`' + repo + '\`) — [tool page](https://mcp-tool-shop.github.io/tools/' + repo + '/)\n';
            }
          }

          if (noScreenshot.length > 0) {
            body += '\n### No screenshot at all (' + noScreenshot.length + ')\n\n';
            for (const repo of noScreenshot) {
              const p = projectMap.get(repo);
              const name = p ? p.name : repo;
              body += '- [ ] **' + name + '** (\`' + repo + '\`)\n';
            }
          }

          body += '\n---\n';
          body += '*To replace a placeholder: add a real PNG at \`site/public/screenshots/<slug>.png\` and set \`screenshotType: \"real\"\` in overrides.json.*\n';
          body += '*Auto-generated weekly by the screenshots-weekly workflow.*';

          // Write to file to avoid shell escaping issues
          fs.writeFileSync('/tmp/backlog-body.md', body);
          console.log('Backlog: ' + placeholders.length + ' placeholders, ' + noScreenshot.length + ' missing');
          "

      - name: Create or update backlog issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TITLE="Screenshot backlog"
          BODY=$(cat /tmp/backlog-body.md)

          # Find existing open issue with this title
          EXISTING=$(gh issue list --state open --search "Screenshot backlog in:title" --json number,title --jq '.[] | select(.title == "Screenshot backlog") | .number' | head -1)

          if [ -n "$EXISTING" ]; then
            echo "Updating existing issue #$EXISTING"
            gh issue edit "$EXISTING" --body "$BODY" || echo "::warning::Could not update issue."
          else
            echo "Creating new backlog issue"
            gh issue create \
              --title "$TITLE" \
              --body "$BODY" \
              --label "screenshots,automation" \
            || echo "::warning::Could not create issue. Create manually."
          fi
